# This workflow automatically creates a documentation tracking issue in the dotnet/AspNetCore.Docs
# repository when a breaking change issue is opened or labeled in this repository.
#
# Setup Requirements:
# - A GitHub Personal Access Token (PAT) or GitHub App token with 'repo' scope must be configured
#   as a repository secret named 'DOCS_ISSUE_TOKEN' to allow creating issues in the docs repo.
# - If DOCS_ISSUE_TOKEN is not configured, the workflow will attempt to use GITHUB_TOKEN,
#   but this will likely fail due to insufficient permissions for cross-repository operations.

name: "Create Docs Issue for Breaking Change"
on: 
  issues:
    types: [opened, labeled]

jobs:
  create-docs-issue:
    runs-on: ubuntu-latest
    # Only run if the issue has the "Breaking change" label
    if: contains(github.event.issue.labels.*.name, 'Breaking change')
    # Prevent concurrent runs for the same issue to avoid race conditions
    concurrency:
      group: docs-issue-${{ github.event.issue.number }}
      cancel-in-progress: false
    steps:
      - name: Create issue in aspnetcore.docs
        uses: actions/github-script@v7
        with:
          # Use a token with cross-repository permissions
          # The GITHUB_TOKEN doesn't have permission to create issues in other repos
          # A PAT with repo scope should be stored as a secret (e.g., DOCS_ISSUE_TOKEN)
          github-token: ${{ secrets.DOCS_ISSUE_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = context.payload.issue.title;
            const issueNumber = context.payload.issue.number;
            const issueUrl = context.payload.issue.html_url;
            const issueBody = context.payload.issue.body || '';
            
            // Check if we've already created a docs issue for this breaking change
            // First, check for existing comments in the current issue
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const commentExists = comments.data.some(comment => 
              comment.body.includes('A documentation tracking issue has been created')
            );
            
            if (commentExists) {
              console.log('Docs issue comment already exists. Skipping.');
              return;
            }
            
            // Also check the docs repository for existing issues with the same title
            // Use a more robust search that can handle special characters
            const docsIssueTitle = `[Breaking Change] ${issueTitle}`;
            const escapedTitle = docsIssueTitle.replace(/"/g, '\\"');
            const searchResults = await github.rest.search.issuesAndPullRequests({
              q: `"${escapedTitle}" repo:dotnet/AspNetCore.Docs is:issue in:title`
            });
            
            if (searchResults.data.total_count > 0) {
              console.log('Docs issue already exists in target repository. Skipping.');
              // Add comment to the original issue with link to existing docs issue if not already present
              const existingDocsIssue = searchResults.data.items[0];
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `üìù A documentation tracking issue has been created: ${existingDocsIssue.html_url}`
                });
              } catch (commentError) {
                console.error('Failed to post comment about existing docs issue:', commentError);
                // Don't fail the workflow if we can't post the comment
              }
              return;
            }
            
            // Create the issue body for the docs repo
            const docsIssueBody = `This issue tracks adding documentation for a breaking change announced in aspnet/Announcements.

**Breaking Change Issue:** ${issueUrl}
**Issue Number:** #${issueNumber}
**Title:** ${issueTitle}

---

${issueBody}

---

Please add documentation for this breaking change to the ASP.NET Core documentation.`;
            
            // Create the issue in dotnet/aspnetcore.docs
            try {
              const newIssue = await github.rest.issues.create({
                owner: 'dotnet',
                repo: 'AspNetCore.Docs',
                title: `[Breaking Change] ${issueTitle}`,
                body: docsIssueBody,
                labels: ['breaking-change', 'aspnet/Announcements']
              });
              
              console.log(`Created issue: ${newIssue.data.html_url}`);
              
              // Comment on the original issue with a link to the docs issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `üìù A documentation tracking issue has been created: ${newIssue.data.html_url}`
              });
            } catch (error) {
              console.error('Error creating docs issue:', error);
              // Check if error is due to missing token permissions
              if (error.status === 403 || error.status === 401) {
                throw new Error(`Failed to create docs issue due to insufficient permissions. Please ensure DOCS_ISSUE_TOKEN secret is configured with 'repo' scope. Error: ${error.message}`);
              }
              throw new Error(`Failed to create docs issue: ${error.message}`);
            }
