# This workflow automatically creates a documentation tracking issue in the dotnet/AspNetCore.Docs
# repository when a breaking change issue is opened or labeled in this repository.
#
# Setup Requirements:
# - A GitHub Personal Access Token (PAT) or GitHub App token with 'repo' scope must be configured
#   as a repository secret named 'DOCS_ISSUE_TOKEN' to allow creating issues in the docs repo.
# - If DOCS_ISSUE_TOKEN is not configured, the workflow will attempt to use GITHUB_TOKEN,
#   but this will likely fail due to insufficient permissions for cross-repository operations.

name: "Create Docs Issue for Breaking Change"
on: 
  issues:
    types: [opened, labeled]

jobs:
  create-docs-issue:
    runs-on: ubuntu-latest
    # Only run if the issue has the "Breaking change" label
    if: contains(github.event.issue.labels.*.name, 'Breaking change')
    # Limit permissions to only what's needed
    permissions:
      issues: write
      contents: read
    # Prevent concurrent runs for the same issue to avoid race conditions
    concurrency:
      group: docs-issue-${{ github.event.issue.number }}
      cancel-in-progress: false
    steps:
      - name: Create issue in aspnetcore.docs
        uses: actions/github-script@v7
        with:
          # Use a token with cross-repository permissions
          # The GITHUB_TOKEN doesn't have permission to create issues in other repos
          # A PAT with repo scope should be stored as a secret (e.g., DOCS_ISSUE_TOKEN)
          github-token: ${{ secrets.DOCS_ISSUE_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = context.payload.issue.title;
            const issueNumber = context.payload.issue.number;
            const issueUrl = context.payload.issue.html_url;
            const issueBody = context.payload.issue.body || '';
            
            // Check if we've already created a docs issue for this breaking change
            // First, check for existing comments in the current issue
            let commentExists = false;
            try {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              commentExists = comments.data.some(comment => 
                comment.body.includes('A documentation tracking issue has been created')
              );
              
              if (commentExists) {
                console.log('Docs issue comment already exists. Skipping.');
                return;
              }
            } catch (error) {
              console.warn('Failed to fetch comments, proceeding with search-based duplicate detection:', error);
              // Continue with search-based duplicate detection
            }
            
            // Also check the docs repository for existing issues with the same title
            // Use a more robust search that can handle special characters
            const docsIssueTitle = `[Breaking Change] ${issueTitle}`;
            // Properly escape double quotes for use in search query
            const escapedTitle = docsIssueTitle.replace(/"/g, '\\\\"');
            
            try {
              const searchResults = await github.rest.search.issuesAndPullRequests({
                q: `"${escapedTitle}" repo:dotnet/AspNetCore.Docs is:issue in:title`
              });
              
              if (searchResults.data.total_count > 0) {
                console.log('Docs issue already exists in target repository.');
                const existingDocsIssue = searchResults.data.items[0];
                
                // Try to add a comment with link to existing docs issue
                try {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `üìù A documentation tracking issue has been created: ${existingDocsIssue.html_url}`
                  });
                  console.log('Added comment linking to existing docs issue.');
                } catch (commentError) {
                  console.error('Failed to post comment about existing docs issue:', commentError);
                  // Don't fail the workflow if we can't post the comment
                }
                return;
              }
            } catch (searchError) {
              console.warn('Search for existing docs issues failed, proceeding with issue creation:', searchError);
              // If search fails, proceed with creating the issue to avoid missing documentation
            }
            
            // Create the issue body for the docs repo
            const docsIssueBody = `This issue tracks adding documentation for a breaking change announced in aspnet/Announcements.

**Breaking Change Issue:** ${issueUrl}
**Issue Number:** #${issueNumber}
**Title:** ${issueTitle}

---

${issueBody}

---

Please add documentation for this breaking change to the ASP.NET Core documentation.`;
            
            // Create the issue in dotnet/aspnetcore.docs
            let newIssue;
            try {
              newIssue = await github.rest.issues.create({
                owner: 'dotnet',
                repo: 'AspNetCore.Docs',
                title: `[Breaking Change] ${issueTitle}`,
                body: docsIssueBody,
                labels: ['breaking-change', 'aspnet/Announcements']
              });
              
              console.log(`Created docs issue: ${newIssue.data.html_url}`);
            } catch (error) {
              console.error('Error creating docs issue:', error);
              // Check if error is due to missing token permissions
              if (error.status === 403 || error.status === 401) {
                throw new Error(`Failed to create docs issue due to insufficient permissions. Please ensure DOCS_ISSUE_TOKEN secret is configured with 'repo' scope. Error: ${error.message}`);
              }
              throw new Error(`Failed to create docs issue: ${error.message}`);
            }
            
            // Comment on the original issue with a link to the docs issue
            // This is in a separate try-catch so the workflow doesn't fail if commenting fails
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `üìù A documentation tracking issue has been created: ${newIssue.data.html_url}`
              });
              console.log('Added comment to original issue.');
            } catch (commentError) {
              console.error('Failed to post comment on original issue:', commentError);
              // Don't fail the workflow - the docs issue was created successfully
              console.log(`Docs issue created successfully at ${newIssue.data.html_url} but failed to comment on source issue.`);
            }
